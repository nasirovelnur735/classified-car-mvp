"""
Агент генерации текстового описания объявления. Логика и стиль из Untitled.ipynb.
Вход: images_base64, classification_result, vision_result, df_for_pricing (dict). Выход: строка описания.
"""
import json
import time
from .client import get_client, get_model

# Повторные попытки при ошибках соединения
DESCRIPTION_MAX_RETRIES = 2
DESCRIPTION_RETRY_DELAY_SEC = 2
DESCRIPTION_TIMEOUT_SEC = 120


def run_description(
    images_base64: list[str],
    classification_result: dict,
    vision_result: dict,
    df_for_pricing: dict,
) -> str:
    prompt = f"""
Ты — агент генерации продающих описаний
для объявлений о продаже подержанных автомобилей.

Все данные относятся к ОДНОМУ автомобилю.

ТВОЯ ЗАДАЧА:
На основе предоставленных данных составить
насыщенное, конкретное и честное описание,
которое помогает покупателю быстро понять:
что это за машина и в каком она состоянии, обязательно пиши от первого лица

────────────────────
ОБЯЗАТЕЛЬНЫЕ ИСТОЧНИКИ
────────────────────
1. classification_result — модель, тип кузова, двигатель, КПП, привод и т.п.
2. vision_result — состояние кузова, салона, дефекты, особенности
3. df_for_pricing — год, пробег, комплектация и доп. параметры

Если данных не хватает в одном источнике — используй другой.

────────────────────
ОБЯЗАТЕЛЬНЫЕ СМЫСЛОВЫЕ БЛОКИ
(ВСЕ ДОЛЖНЫ ПРИСУТСТВОВАТЬ В ТЕКСТЕ, если есть данные)
────────────────────
1. Базовая информация:
   марка, модель, год, тип кузова, двигатель, КПП, привод, пробег

2. Состояние автомобиля:
   — кузов (состояние, ЛКП, коррозия, царапины, вмятины);
   — двигатель и подвеска (по данным vision/классификации);
   — был ли автомобиль в ДТП (битый/не битый) — указать явно, если известно

3. Колёса и резина:
   какие диски и резина стоят, есть ли второй (зимний/летний) комплект — только если видно или указано

4. Состояние салона:
   обивка, руль, приборка, износ — по факту из данных

5. Тюнинг и доп. опции:
   сигнализация, предпусковой подогреватель (вебасто), парктроники, камера, круиз, подогрев сидений и т.п. — только при наличии в данных

6. 2–3 ключевых преимущества:
   практичность, надёжность, проходимость, удобство эксплуатации

7. Видимые особенности или дефекты:
   если есть — упомяни честно, без сглаживания

8. Торг:
   возможен ли торг — указать, если это отражено в данных или уместно (например «торг уместен» / «цена фиксирована»)

9. Короткий нейтральный призыв к связи

────────────────────
ФОРМАТ И СТИЛЬ
────────────────────
- Сплошной текст, без списков и подзаголовков
- Разговорно-деловой тон
- Конкретные факты, минимум общих слов
- Без восклицательных знаков
- Без рекламных клише
- 10-12 предложений
- Текст должен быть написан так, как если бы его писал владелец автомобиля, а не эксперт или система анализа.

────────────────────
ЗАПРЕЩЕНО
────────────────────
- Придумывать характеристики
- Оценивать цену или рынок
- Использовать слова "идеальный", "лучший", "безупречный"
- Скрывать дефекты
- упоминать источники информации в тексте
  (например: "по фото", "видно на изображениях",
   "визуально", "на снимках")

ВАЖНО:
Если по какому-либо аспекту автомобиля
(салон, подкапотное пространство, комплектация,
нижняя часть кузова и т.п.)
в переданных данных НЕТ ЯВНОЙ ИНФОРМАЦИИ
— этот аспект НУЖНО ПРОПУСТИТЬ
и НЕ УПОМИНАТЬ в тексте вообще.

Запрещено:
- делать предположения
- писать об аспектах "в целом"
- использовать общие фразы при отсутствии данных

ДАННЫЕ:
classification_result: {json.dumps(classification_result, ensure_ascii=False)}
vision_result: {json.dumps(vision_result, ensure_ascii=False)}
df_for_pricing: {json.dumps(df_for_pricing, ensure_ascii=False)}

Сформируй продающее описание. Только текст, без заголовков.
"""
    client = get_client()
    model = get_model()
    content = [{"type": "text", "text": prompt}]
    for b64 in images_base64[:5]:  # не более 5 фото для контекста
        url = f"data:image/jpeg;base64,{b64}" if not b64.startswith("data:") else b64
        content.append({"type": "image_url", "image_url": {"url": url}})

    last_error = None
    for attempt in range(DESCRIPTION_MAX_RETRIES + 1):
        try:
            resp = client.chat.completions.create(
                model=model,
                messages=[{"role": "user", "content": content}],
                max_completion_tokens=1024,
                timeout=DESCRIPTION_TIMEOUT_SEC,
            )
            return (resp.choices[0].message.content or "").strip()
        except Exception as e:
            last_error = e
            err_str = str(e).lower()
            is_connection_error = (
                "connection" in err_str or "timeout" in err_str or "connect" in err_str
            )
            if attempt < DESCRIPTION_MAX_RETRIES and is_connection_error:
                time.sleep(DESCRIPTION_RETRY_DELAY_SEC)
                continue
            break

    msg = str(last_error) if last_error else "неизвестная ошибка"
    if "connection" in msg.lower() or "timeout" in msg.lower() or "connect" in msg.lower():
        return "[Не удалось сгенерировать описание: проблема с соединением или таймаут. Проверьте интернет и попробуйте снова или заполните описание вручную.]"
    return f"[Ошибка генерации описания: {msg}]"
