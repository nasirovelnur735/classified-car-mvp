# Мультиагентная система: суть работы и описание агентов

## Суть работы

Проект — это **MVP веб-сервиса для подготовки объявления о продаже подержанного автомобиля**. Пользователь загружает фотографии машины; система с помощью нескольких AI-агентов автоматически заполняет параметры авто, оценивает состояние, подсказывает цену и формирует текст объявления. Пользователь может править любые поля, добавлять или удалять фото, пересчитывать цену и перегенерировать описание. Итог — готовое объявление с заполненными полями и рекомендациями по фото.

**Принцип:** агенты из исследовательского ноутбука (`Untitled.ipynb`) не переписываются — они вызываются как «чёрные ящики», а оркестратор собирает их ответы в единый контракт (JSON). ИИ не затирает правки пользователя: пересчёт цены и перегенерация описания всегда опираются на текущие данные формы.

---

## Архитектура: оркестратор и агенты

**Оркестратор** (`backend/app/orchestrator.py`) принимает изображения (в base64), последовательно или параллельно вызывает агентов, маппит их выходы в канонические схемы и возвращает один объект `AnalysisResponse`. Дополнительно оркестратор реализует пересчёт цены и перегенерацию описания по уже введённым/изменённым данным.

**Агенты** живут в `backend/agents/`. Каждый — отдельный модуль с промптами и вызовами LLM (OpenAI Chat Completions, при необходимости с vision). Ниже перечислены все агенты системы.

---

## Агенты

### 1. Агент визуальной инспекции (`vision.py`)

- **Вход:** список изображений (base64).
- **Выход:** структурированный JSON с полями:
  - **damage_flag** — «битый» | «не битый» | «не определено» (по чётким критериям деформации кузова);
  - **visual_condition_score**, **inspection_reliability_score** (0–1);
  - **defects** — список дефектов (тип, локация, выраженность, уверенность);
  - **image_quality_flags** (размытие, освещение, перекрытие и т.д.);
  - **inspection_by_category**, **limitations**, **raw_text_description**.
- **Суть:** оценивает только то, что видно на фото: состояние кузова и салона, дефекты, пригодность снимков для осмотра. Не оценивает стоимость и не сравнивает с другими авто.

---

### 2. Агент классификации (`classification.py`)

- **Вход:** те же изображения (base64).
- **Выход:** марка, модель, тип кузова, цвет, положение руля, КПП и др. — всё, что можно визуально определить по фото.
- **Суть:** распознаёт параметры автомобиля по изображениям и возвращает структурированную классификацию для заполнения карточки объявления.

---

### 3. Агент оценки рыночной стоимости (`pricing.py`)

- **Вход:** полный набор полей по авто (марка, модель, тип кузова, цвет, год, объём двигателя, КПП, привод, пробег, признак ДТП, баллы состояния, дефекты).
- **Логика:**
  - Если каких-то полей не хватает — возвращает список **missing_fields** без подстановки значений по умолчанию.
  - Если всё заполнено: по промпту LLM генерирует **синтетические данные** (набор строк по той же марке/модели с разным годом, пробегом, состоянием и ценой); на них обучается **CatBoost**; для текущего авто делается предсказание цены; диапазон задаётся как **suggested_price ± MAE** (MAE по тестовой выборке).
- **Выход:** min_price, max_price, suggested_price, mae, confidence, missing_fields, при успехе — также **generated_rows** (таблица сгенерированных строк для прозрачности).
- **Суть:** гибрид LLM + ML: LLM создаёт обучающую выборку, регрессор даёт точечную оценку и диапазон цены.

---

### 4. Агент генерации описания (`description.py`)

- **Вход:** изображения, результаты классификации и визуальной инспекции, данные для цены (df_for_pricing).
- **Выход:** текст объявления (generated_description).
- **Суть:** формирует связный текст объявления для доски объявлений, опираясь на все доступные данные и визуальный контекст.

---

### 5. Агент преобразования изображений (`augmentation.py`)

- **Вход:** одно изображение (bytes) и текстовый запрос (prompt).
- **Логика:** проверяет запрос на предмет автомобиля и реалистичности сцены; поддерживает режимы улучшения (improve) и дополнения сцены (augment).
- **Выход:** success, image_base64 при успехе, иначе error и при необходимости mode.
- **Суть:** позволяет пользователю «дообработать» фото (улучшить качество или добавить объект) с контролем домена и реалистичности.

---

### 6. Агент-рекомендатель по фото (`recommender.py`)

- **Вход:** список изображений (base64), опционально контекст «марка модель».
- **Выход:** JSON:
  - **verdict** — «all_ok» | «has_recommendations»;
  - **quality_issues** — замечания по качеству (размытость, освещение и т.д.);
  - **recommendations** — общие советы;
  - **missing_photo_types** — каких снимков не хватает (вид спереди, салон, одометр, VIN, двигатель и т.п.);
  - **summary** — краткий итог.
- **Суть:** оценивает, хорошо ли сделаны фото, не размыты ли, с каких ракурсов лучше снять и каких фото не хватает для объявления; при отсутствии замечаний возвращает «всё замечательно».

---

## Поток данных

1. **Пользователь** загружает одно или несколько фото → **POST /api/analyze**.
2. **Оркестратор** параллельно вызывает **vision** и **classification**, затем по их результатам собирает car_identity, visual_condition, technical_assumptions.
3. По собранным данным вызывается **pricing** (при нехватке полей — только missing_fields).
4. Вызывается **description** → generated_description.
5. Формируются confidence_warnings и status → возвращается **AnalysisResponse**.
6. На экране редактирования пользователь может:
   - править поля, добавлять/удалять фото;
   - нажать «Пересчитать цену» → **recalculate_price** (оркестратор снова вызывает **pricing** с текущими данными);
   - перегенерировать описание → **regenerate_description** (оркестратор вызывает **description** с текущими данными);
   - получить рекомендации по фото → **POST /api/photo-recommendations** (вызов **recommender**);
   - преобразовать изображение → **POST /api/augment-image** (вызов **augmentation**).

---

## Итог

Мультиагентная система объединяет **шесть агентов**: визуальная инспекция, классификация, оценка цены (LLM + CatBoost), генерация описания, преобразование изображений и рекомендации по фото. Оркестратор не меняет логику агентов, а только вызывает их и приводит ответы к единому контракту. Суть работы — превратить фото автомобиля в готовое к публикации объявление с заполненными полями, оценкой состояния, ценой и текстом, с возможностью правок и улучшения набора фото по советам агента-рекомендателя.
